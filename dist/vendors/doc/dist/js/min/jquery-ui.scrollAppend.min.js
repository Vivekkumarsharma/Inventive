!function(o){o.widget("ui.scrollAppend",{options:{pixelBuffer:400,pageVar:"p",expireCacheMins:20,pagesToPause:5,loadingImage:"/images/loading.gif",moreText:"Show More",disableCache:!1,footerClass:void 0,contentClass:void 0,footerSpeed:400},_create:function(){var e=this;e.loading=!1,e.page=0,e.stop=!1,e.pause=!1,e.stopFixed=!1,e.footerUp=!1,e.lastScrollPos=void 0,e.position=void 0,e.appearedOnce=!1,e.options.contentClass=void 0;var t=e.options.params;t[e.options.pageVar]=0;var a=jQuery.param(t);if(e.param_key=a,this.clearOld(),!e.options.disableCache){var s=localStorage.getItem("scroll_"+e.param_key);if(void 0!=s){{localStorage.getItem("time_"+e.param_key)}e.page=localStorage.getItem("p_"+e.param_key),o(this.options.appendTo).append(s),e.options.callback&&e.options.callback.apply()}}void 0!=e.options.footerClass&&e.setFixed(),e.checkAppend(),o(window).scroll(function(){e.checkAppend(),void 0==e.options.footerClass||e.loading||e.checkDirection()}),o(document).on("click","#scroll_append_more",function(){return e.append(),o(this).remove(),e.pause=!1,!1})},checkAppend:function(){var e=this,t=o(document).height()-o(window).height();if(o(window).scrollTop()>=t-e.options.pixelBuffer&&!e.loading){if(e.stop)return;e.pause||e.append()}},toggleFooter:function(e){var t=this;if(void 0!=t.options.footerClass){var a=o(t.options.footerClass).outerHeight();t.footerUp?e||(o(t.options.footerClass).stop(!0,!0).animate({bottom:-a},{duration:t.options.footerSpeed,queue:!1}),void 0!=t.options.contentClass&&o(t.options.contentClass).stop(!0,!0).animate({"margin-bottom":0},{duration:t.options.footerSpeed,queue:!1}),t.footerUp=!1,t.stopFixed=!0):(o(t.options.footerClass).stop(!0,!0).animate({bottom:0},{duration:t.options.footerSpeed,queue:!1}),void 0!=t.options.contentClass&&o(t.options.contentClass).stop(!0,!0).animate({"margin-bottom":a},{duration:t.options.footerSpeed,queue:!1}),t.appearedOnce=!0,t.footerUp=!0)}},setFixed:function(){var e=this;if(!e.stop&&!e.pause&&"fixed"!=e.position){var t=o(e.options.footerClass).outerHeight();o(e.options.footerClass).css("bottom",-t),o(e.options.footerClass).addClass("footer_fixed"),void 0!=e.options.contentClass&&o(e.options.contentClass).css("margin-bottom",0),e.footerUp=!1,e.position="fixed"}},setRelative:function(){var e=this;"relative"!=e.position&&(o(e.options.footerClass).removeClass("footer_fixed"),o(e.options.footerClass).css("bottom",0),void 0!=e.options.contentClass&&o(e.options.contentClass).css("margin-bottom",0),e.appearedOnce&&(e.stopFixed=!0),e.position="relative")},checkDirection:function(){var e=this,t=o(window).scrollTop();t<e.lastScrollPos?(e.atBottom=!1,e.setRelative()):e.setFixed(),e.lastScrollPos=t},append:function(){var e=this;e.loading=!0,e.page++,e.options.params[e.options.pageVar]=e.page;e.options.loadingImage&&o(e.options.appendTo).append("<div id='scroll_append_loading' class='scroll_append_loading'><img src='"+e.options.loadingImage+"'></div>"),e.stopFixed||e.toggleFooter(),o.ajax({url:e.options.url,data:e.options.params,cache:!1,success:function(t){if(o("#scroll_append_loading").remove(),"false"==t)e.stop=!0;else if(o(e.options.appendTo).append(t),!e.options.disableCache){var a=localStorage.getItem("scroll_"+e.param_key);null===a&&(a=""),e.saveData("scroll_"+e.param_key,a+t),e.saveData("p_"+e.param_key,e.page);var s=Number(new Date);e.saveData("time_"+e.param_key,s)}var i=e.page%e.options.pagesToPause;0!=i||e.stop||(o(e.options.appendTo).append("<div id='scroll_append_more' class='scroll_append_more'>"+e.options.moreText+"</div>"),e.pause=!0),(e.pause||e.stop)&&e.setRelative(),e.options.callback&&e.options.callback.apply(),e.loading=!1}})},saveData:function(o,e){try{localStorage.setItem(o,e)}catch(t){22==t.code&&this.clearOld()}},clearOld:function(){for(var o=0;o<localStorage.length;o++){var e=Number(new Date),t=new RegExp("^time_(.+)","g"),a=localStorage.key(o),s=t.exec(a);if(s){var i=s[1],p=localStorage.getItem(a),n=e-p;n=Math.round(n/1e3/60),n>=this.options.expireCacheMins&&(localStorage.removeItem("scroll_"+i),localStorage.removeItem("p_"+i),localStorage.removeItem("time_"+i))}}}})}(jQuery);